<!doctype html>
<html>
	<head>
	    <title>MVC in just javascript</title>
		<style type="text/css">
			html, body{
				margin: 0;
				padding: 0;
			}
			body{
				font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
				font-size: 16px;
				line-height: 1.5em;
				background: #EEE;
				color: #333;
			}
			h1, h2{
				margin: 0;
				padding: 0;
			}
			input[type="text"]{
				font-size: 1.5em;
				width: 100%;
			}
			ul{
				margin: 0;
				padding: 0;
				list-style: none;
			}
			p{
				margin: 0;
				padding: 0;
			}
			ul li{
				margin: 0;
			}
			li{
				padding: 12px 20px 11px 0;
				position: relative;
				font-size: 24px;
				line-height: 1.1em;
				border-bottom: 1px solid #CCC;
			}
			li input[type="text"]{
				font-size: 1em;
				width: 90%;
				border: solid 1px transparent;
				margin-left: .5em;
				background: transparent;
			}
			.view{
				width: 480px;
				margin: 0 auto 40px;
				background: white;
				padding: 0;
				box-shadow: rgba(0, 0, 0, 0.2) 0 3px 7px 0;
				border-radius: 0 0 5px 5px;
			}
			.view header{
				margin: 0 auto;
				text-align: center;
			}
			.view header
			, .view article{
				padding: 0 40px;
			}
			.view header h1{
				font-size: 36px;
				font-weight: bold;
				text-align: center;
				padding: 20px 0 30px 0;
				line-height: 1;
			}
			.credits{
				color: #999;
				text-shadow: rgba(255, 255, 255, 0.8) 0 1px 0;
				text-align: center;
			}
			.view article{
				position: relative;
			}
			.view .tip{
				display: block;
				position: absolute;
				top: .5em;
				right: -4em;
				background: black;
				color: white;
				border-radius: 5px;
				padding: .3em .5em .3em .5em;
				font-size: .8em;
				text-align: center;
				box-shadow: 0 0 3px 1px rgba(0,0,0,.8);
				border: solid 1px transparent;
			}
			.view footer{
				position: relative;
				background: none repeat scroll 0 0 #F4FCE8;
				border-bottom-left-radius: 5px;
				border-bottom-right-radius: 5px;
				border-top: 1px solid #EDEDED;
				color: #555;
				line-height: 36px;
				margin-top: 10px;
				width: 100%;
				height: 36px;
			}
			.view footer p{
				padding-left: 1em;
			}
		</style>
	</head>
	<body>
		<section>
		    <div id="todoapp" class="view">
		        <header>
		            <h1>Todos</h1>
		        </header>
				<article>
					<input id="new-todo" placeholder="What needs to be done?" type="text" />
					<button type="button" class="tip" id="add_button">hit enter</button>
	                <ul id="todos"></ul>
		        </article>
	            <footer>
	            	<p id="todo-stats"></p>
	            </footer>
		    </div>
		</section>
	    <footer class="credits">Created by <a href="http://www.joeyguerra.com/" title="Joey Guerra">Joey Guerra</a></footer>
	    <script>
			(function(){
				function model(){
					var dependents = [];
					this.subscribe = function(key, subscriber){
						if(dependents[key] === undefined) dependents[key] = [];
						dependents[key].push(subscriber);
					};
					this.unsubscribe = function(subscriber){
						var i = 0;
						var ubounds = dependents.length;
						for(i; i<ubounds; i++){
							var k = 0;
							var upper = dependents[i].length;
							for(k = 0; k < upper; k++){
								if(dependents[i][k] === subscriber){
									dependents[i].splice(k, 1);
									if(dependents[i].length === 0) delete dependents[i];
									break;
								}
							}
						}
					};
					this.changed = function(key, old, v){
						if(dependents[key] === undefined) return;
						var i = 0;
						var ubounds = dependents[key].length;
						for(i; i<ubounds; i++){
							dependents[key][i].update(key, old, v, this);
						}
					}
				}
				function todo(){
					model.apply(this, []);
					this.timestamp = (new Date()).getTime();
					this.order = 0;
					this.done = false;
					this.editing = false;
					this.content = null;
					return this;
				}
				
				/*Controllers namespace*/
				var controllers = {};
				
				/*List controller*/
				controllers.list = function(){
					var view = null;
					var model = null;
					this.__defineGetter__("view", function(){
						return view;
					});
					this.__defineSetter__("view", function(v){
						if(view) view.release();
						view = v;
						view.container.addEventListener("blur", this, true);
						view.container.addEventListener("keypress", this, true);
						view.container.addEventListener("click", this, true);
						model = v.model;
					});
					this.__defineGetter__("model", function(){
						return model;
					});
					this.__defineSetter__("model", function(v){
						model = v;
					});
					return this;
				};
				controllers.list.prototype.save = function(id, value){
					for(var i = 0; i < this.model.length(); i++){
						if(id === this.model.item(i).timestamp){
							this.model.item(i).content = value;
							break;
						}
					}
				};
				controllers.list.prototype.handleEvent = function(e){
					if(this[e.type]) this[e.type](e);
				};
				controllers.list.prototype.blur = function(e){
					this.save(parseInt(e.target.id), e.target.value);
				};
				controllers.list.prototype.keypress = function(e){
					if(e.which !== 13) return;
					this.view.select_next(e.target);
				};
				controllers.list.prototype.click = function(e){
					if(e.target.type && e.target.type === "checkbox"){
						var t = new todo();
						t.timestamp = parseInt(e.target.id);
						this.model.pop(t);
					}
				};
				
				/*Editing controller*/
				controllers.editing = function(){
					var view = null;
					var model = null;
					this.__defineGetter__("view", function(){
						return view;
					});
					this.__defineSetter__("view", function(v){
						if(view) view.release();
						v.add_button.addEventListener("click", this, true);
						v.field.addEventListener("keypress", this, true);
						view = v;
						model = v.model;
					});
					this.__defineGetter__("model", function(){
						return model;
					});
					this.__defineSetter__("model", function(v){
						model = v;
					});
					this.release = function(v){
						view = null;
					};
					return this;
				};
				controllers.editing.prototype.handleEvent = function(e){
					if(this.view.value.length === 0) return;
					if(this[e.type]) this[e.type](e);
				};
				controllers.editing.prototype.keypress = function(e){
					if(e.which !== 13) return;
					var t = new todo();
					t.order = this.model.length();
					t.content = this.view.value;
					this.model.push(t);
					e.target.value = "";
				};
				controllers.editing.prototype.click = function(e){
					if(e.target !== this.view.add_button) return;
					var t = new todo();
					t.order = this.model.length();
					t.content = this.view.value;
					this.model.push(t);
					this.view.value = "";
					this.view.focus();
				};

				/*parent view*/
				function view(id, model, controller){
					this.container = document.getElementById(id);
					this.model = model;
					this.controller = controller;
					this.release = function(){
						this.controller.release(this);
						this.model.unsubscribe(this);
					};
					return this;
				}
				
				/*views namespace*/
				var views = {};
				views.editing = function(id, model, controller){
					view.apply(this, [id, model, controller]);
					this.__defineGetter__("field", function(){
						return field;
					});
					this.__defineGetter__("value", function(){
						return field.value;
					});
					this.__defineSetter__("value", function(v){
						field.value = v;
					});

					var field = this.container.querySelector("input");
					this.add_button = this.container.querySelector("#add_button");
					this.stats = this.container.querySelector("#todo-stats");
					this.model.subscribe("todos.push", this);
					this.model.subscribe("todos.pop", this);
					this.controller.view = this;
					this.controller.model = this.model;					
					
					// Define as priveleged so we can keep the field property private.
					this.focus = function(){
						field.focus();
					};
					return this;
				}
				views.editing.prototype.update = function(key, old, v, m){
					if(this[key] === undefined) return;
					this[key](old, v, m);
				};
				views.editing.prototype["todos.push"] = function(old, v, m){
					this.stats.innerHTML = m.length() + " items left.";
				};
				views.editing.prototype["todos.pop"] = function(old, v, m){
					this.stats.innerHTML = m.length() + " items left.";
				};
				
				/*list view*/
				views.list = function(id, model, controller){
					this.__defineGetter__("value", function(){
						return this.container.querySelector("input:focus").value;
					});
					this.__defineSetter__("value", function(v){
						this.container.querySelector("input:focus").value = v;
					});
					view.apply(this, [id, model, controller]);
					this.model.subscribe("todos.push", this);
					this.model.subscribe("todos.pop", this);
					this.controller.view = this;
					this.controller.model = this.model;					
					return this;
				}
				views.list.prototype.select_next = function(elem){
					var li = elem.parentNode;
					var items = this.container.querySelectorAll("li");
					var i = 0;
					var item = null;
					for(i = 0; i < items.length - 1; i++){
						if(li === items[i]){
							item = items[i+1];
						}
					}
					if(item === null) return;
					item.querySelector("input[type='text']").focus();
				}
				views.list.prototype.update = function(key, old, v, m){
					if(this[key] === undefined) return;
					this[key](old, v, m);
				};
				views.list.prototype.remove = function(todo){
					var elements = this.container.querySelectorAll('li input[type="text"]');
					for(i in elements){
						if(parseInt(elements[i].id) === todo.timestamp){
							this.container.removeChild(elements[i].parentNode);
							break;
						}
					}
				};
				views.list.prototype.add = function(todo){
					var item = document.createElement("li");
					var field = document.createElement("input");
					var checkbox = document.createElement("input");
					checkbox.type = "checkbox";
					checkbox.id = todo.timestamp;
					field.value = todo.content;
					field.type = "text";
					field.id = todo.timestamp;
					item.appendChild(field);
					item.appendChild(checkbox);
					this.container.appendChild(item);
					return item;
				};
				views.list.prototype["todos.push"] = function(old, v, m){
					this.add(v);
				};
				views.list.prototype["todos.pop"] = function(old, v, m){
					this.remove(v);
				};
				
				function todos(){
					var list = [];
					var self = {
						push: function(todo){
							var found = false;
							for(i in list){
								if(list[i].timestamp === todo.timestamp){
									list[i] = todo;
									found = true;
								}
							}
							if(!found) list.push(todo);
							this.changed("todos.push", null, todo, this);
						}
						, pop: function(todo){
							var i = 0;
							var ubounds = list.length;
							for(i; i<ubounds; i++){
								if(list[i].timestamp === todo.timestamp){
									var removed = list.splice(i, 1);
									this.changed("todos.pop", removed, todo, this);
									return removed;
								}
							}
						}
						, item: function(i){
							return list[i];
						}
						, items: function(){
							return list;
						}
						, length: function(){
							return list.length;
						}
						, find: function(id){
							id = parseInt(id);
							for(i in list){
								if(id === list[i].timestamp) return list[i];
							}
							return null;
						}
					};
					model.apply(self, []);
					return self;
				}
				
				var list = new todos();
				var editing_controller = new controllers.editing();
				var editing = new views.editing("todoapp", list, editing_controller);
				var todos_list = new views.list("todos", list, new controllers.list());
			})();
	    </script>
	</body>
</html>