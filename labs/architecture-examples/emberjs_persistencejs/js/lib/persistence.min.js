function initPersistence(a){if(a.isImmutable)return a;a.isImmutable=function(a){return a=="id"},a.defineProp=function(a,b,c,d){a.__defineSetter__(b,function(a){c(a)}),a.__defineGetter__(b,function(){return d()})},a.set=function(b,c,d){if(a.isImmutable(c))throw new Error("immutable field: "+c);b[c]=d},a.get=function(a,b){return arguments.length==1?a:a[b]},function(){function e(a){return c[a]}function f(a){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={},this.conn=a}function g(f){function j(c,d,e){var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"obj",optional:!0,check:function(a){return a},defaultValue:{}}]);if(h.isMixin)throw new Error("Cannot instantiate mixin");c=g.session,d=g.obj;var j=this;this.id=d.id||a.createUUID(),this._new=!0,this._type=f,this._dirtyProperties={},this._data={},this._data_obj={},this._session=c||a,this.subscribers={};for(var k in h.fields)(function(){if(h.fields.hasOwnProperty(k)){var b=k;a.defineProp(j,b,function(a){var d=j._data[b];if(d!==a||d&&a&&d.getTime&&a.getTime)j._data[b]=a,j._dirtyProperties[b]=d,j.triggerEvent("set",j,b,a),j.triggerEvent("change",j,b,a),c.propertyChanged(j,b,d,a)},function(){return j._data[b]}),j._data[k]=i(h.fields[k])}})();for(var l in h.hasOne)h.hasOne.hasOwnProperty(l)&&function(){var b=l,d=h.hasOne[l].type.meta.isMixin?b+"_class":null;a.defineProp(j,b,function(a){var e=j._data[b],f=j._data_obj[b]||c.trackedObjects[j._data[b]];a==null?(j._data[b]=null,j._data_obj[b]=undefined,d&&(j[d]="")):a.id?(j._data[b]=a.id,j._data_obj[b]=a,d&&(j[d]=a._type),c.add(a),c.add(j)):j._data[b]=a,j._dirtyProperties[b]=e,j.triggerEvent("set",j,b,a),j.triggerEvent("change",j,b,a);if(h.hasOne[b].inverseProperty){var g=j[b];if(g){var i=g[h.hasOne[b].inverseProperty];i.list&&i._filter&&i.triggerEvent("change",j,b,a)}if(f){console.log("OldValue",f);var i=f[h.hasOne[b].inverseProperty];i.list&&i._filter&&i.triggerEvent("change",j,b,a)}}},function(){if(!j._data[b])return null;if(j._data_obj[b]!==undefined)return j._data_obj[b];if(j._data[b]&&c.trackedObjects[j._data[b]])return j._data_obj[b]=c.trackedObjects[j._data[b]],j._data_obj[b];throw new Error("Property '"+b+"' of '"+h.name+"' with id: "+j._data[b]+" not fetched, either prefetch it or fetch it manually.")})}();for(var l in h.hasMany)h.hasMany.hasOwnProperty(l)&&function(){var b=l;h.hasMany[b].manyToMany?a.defineProp(j,b,function(c){if(!c||!c._items)throw new Error("Not yet supported.");var d=c._items;for(var e=0;e<d.length;e++)a.get(j,b).add(d[e])},function(){if(j._data[b])return j._data[b];var d=h.hasMany[b],e=d.type.meta,f=e.hasMany[d.inverseProperty],g=d.mixin?d.mixin.meta.name:h.name,i=f.mixin?f.mixin.meta.name:e.name,k=new a.ManyToManyDbQueryCollection(c,e.name);return k.initManyToMany(j,b),k._manyToManyFetch={table:d.tableName,prop:g+"_"+b,inverseProp:i+"_"+d.inverseProperty,id:j.id},j._data[b]=k,c.uniqueQueryCollection(k)}):a.defineProp(j,b,function(c){if(!c||!c._items)throw new Error("Not yet supported.");var d=c._items;for(var e=0;e<d.length;e++)a.get(j,b).add(d[e])},function(){if(j._data[b])return j._data[b];var d=c.uniqueQueryCollection((new a.DbQueryCollection(c,h.hasMany[b].type.meta.name)).filter(h.hasMany[b].inverseProperty,"=",j));return j._data[b]=d,d})}();this.initialize&&this.initialize();for(var m in d)d.hasOwnProperty(m)&&m!=="id"&&a.set(j,m,d[m])}function k(b,c,d,f){var g=b._session,h=[],i=e(b._type),j=i.fields;for(var l in d)d.hasOwnProperty(l)&&h.push(l);var m=[],n=[];h.forEach(function(a){d[a]===!0&&!i.hasMany[a]?m.push(a):n.push(a)});var o=b._data,p={};m.forEach(function(c){c==="id"?p.id=b.id:i.hasOne[c]?p[c]=o[c]?{id:o[c]}:null:p[c]=a.entityValToJson(o[c],j[c])}),h=n.slice(),a.asyncForEach(h,function(e,f){i.hasOne[e]?b.fetch(c,e,function(a){a?k(a,c,d[e],function(a){p[e]=a,f()}):(p[e]=null,f())}):i.hasMany[e]&&a.get(b,e).list(function(b){p[e]=[],a.asyncForEach(b,function(a,f){var a=b.pop();d[e]===!0?(p[e].push({id:a.id}),f()):k(a,c,d[e],function(a){p[e].push(a),f()})},f)})},function(){f(p)})}if(d[f])return d[f];var h=c[f];j.prototype=new m,j.meta=h,j.prototype.equals=function(a){return this.id==a.id},j.prototype.toJSON=function(){var a={id:this.id};for(var b in this._data)this._data.hasOwnProperty(b)&&(typeof this._data[b]=="object"&&this._data[b]!=null?this._data[b].toJSON!=undefined&&(a[b]=this._data[b].toJSON()):a[b]=this._data[b]);return a},j.prototype.selectJSON=function(c,d,e){var f=this,g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]);c=g.tx,d=g.props,e=g.callback;if(!c){this._session.transaction(function(a){f.selectJSON(a,d,e)});return}var i={};d.forEach(function(a){var b=i,c=a.split(".");for(var d=0;d<c.length;d++){var e=c[d];if(d===c.length-1)if(e==="*"){b.id=!0;for(var f in h.fields)h.fields.hasOwnProperty(f)&&(b[f]=!0);for(var f in h.hasOne)h.hasOne.hasOwnProperty(f)&&(b[f]=!0);for(var f in h.hasMany)h.hasMany.hasOwnProperty(f)&&(b[f]=!0)}else if(e[0]==="["){e=e.substring(1,e.length-1);var g=e.split(/,\s*/);g.forEach(function(a){b[a]=!0})}else b[e]=!0;else b[e]=b[e]||{},b=b[e]}}),k(this,c,i,e)},j.prototype.fetch=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"rel",optional:!1,check:b.hasType("string")},{name:"callback",optional:!1,check:b.isCallback()}]);c=f.tx,d=f.rel,e=f.callback;var i=this,j=this._session;if(!c){j.transaction(function(a){i.fetch(a,d,e)});return}if(!this._data[d])e&&e(null);else if(this._data_obj[d])e&&e(this._data_obj[d]);else{var k=h.hasOne[d].type;k.meta.isMixin&&(k=g(this._data[d+"_class"])),k.load(j,c,this._data[d],function(a){i._data_obj[d]=a,e&&e(a)})}},j.prototype.markDirty=function(a){this._dirtyProperties[a]=!0},j.all=function(c){var d=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a}]);return c=d.session,c.uniqueQueryCollection(new t(c,f))},j.fromSelectJSON=function(c,d,e,f){function i(b){b||(b=new j(c),e.id&&(b.id=e.id)),c.add(b);var g=[];for(var i in e)if(e.hasOwnProperty(i)){if(i==="id")continue;h.fields[i]?a.set(b,i,a.jsonToEntityVal(e[i],h.fields[i])):(h.hasOne[i]||h.hasMany[i])&&g.push(i)}a.asyncForEach(g,function(f,g){if(h.hasOne[f])h.hasOne[f].type.fromSelectJSON(c,d,e[f],function(c){a.set(b,f,c),g()});else if(h.hasMany[f]){var i=a.get(b,f),j=e[f].slice(0),k=h.hasMany[f].type;i.list(d,function(b){a.asyncForEach(j,function(a,e){k.fromSelectJSON(c,d,a,function(a){for(var c=0;c<b.length;c++)if(b[c].id===a.id){e();return}i.add(a),e()})},function(){g()})})}},function(){f(b)})}var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonObj",optional:!1},{name:"callback",optional:!1,check:b.isCallback()}]);c=g.session,d=g.tx,e=g.jsonObj,f=g.callback;if(!d){c.transaction(function(a){j.fromSelectJSON(c,a,e,f)});return}typeof e=="string"&&(e=JSON.parse(e));if(!e){f(null);return}e.id?j.load(c,d,e.id,i):i(new j(c))},j.load=function(c,d,e,f){var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"id",optional:!1,check:b.hasType("string")},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);j.findBy(g.session,g.tx,"id",g.id,g.callback)},j.findBy=function(c,d,e,f,g){var h=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"property",optional:!1,check:b.hasType("string")},{name:"value",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=h.session,d=h.tx,e=h.property,f=h.value,g=h.callback;if(e==="id"&&f in c.trackedObjects){g(c.trackedObjects[f]);return}if(!d){c.transaction(function(a){j.findBy(c,a,e,f,g)});return}j.all(c).filter(e,"=",f).one(d,function(a){g(a)})},j.index=function(a,b){var c=b||{};typeof a=="string"&&(a=[a]),c.columns=a,h.indexes.push(c)},j.hasMany=function(b,c,d){var e=c.meta;if(e.hasMany[d]){var f=h.name+"_"+b+"_"+e.name,g=e.name+"_"+d+"_"+h.name;f>g&&(f=g),h.hasMany[b]={type:c,inverseProperty:d,manyToMany:!0,tableName:f},e.hasMany[d]={type:j,inverseProperty:b,manyToMany:!0,tableName:f},delete h.hasOne[b],delete h.fields[b+"_class"]}else h.hasMany[b]={type:c,inverseProperty:d},e.hasOne[d]={type:j,inverseProperty:b},h.isMixin&&(e.fields[d+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT")},j.hasOne=function(b,c,d){h.hasOne[b]={type:c,inverseProperty:d},c.meta.isMixin&&(h.fields[b+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT")},j.is=function(a){var b=a.meta;if(!b.isMixin)throw new Error("not a mixin: "+a);a.meta.mixedIns=a.meta.mixedIns||[],a.meta.mixedIns.push(h);for(var c in b.fields)b.fields.hasOwnProperty(c)&&(h.fields[c]=b.fields[c]);for(var d in b.hasOne)b.hasOne.hasOwnProperty(d)&&(h.hasOne[d]=b.hasOne[d]);for(var d in b.hasMany)b.hasMany.hasOwnProperty(d)&&(b.hasMany[d].mixin=a,h.hasMany[d]=b.hasMany[d])};var l=a.entityDecoratorHooks;for(var n=0;n<l.length;n++)l[n](j);return d[f]=j,j}function h(){if(a.typeMapper&&a.typeMapper.newUuid)return a.typeMapper.newUuid();var b=[],c="0123456789ABCDEF";for(var d=0;d<32;d++)b[d]=c.substr(Math.floor(Math.random()*16),1);b[12]="4",b[16]=c.substr(b[16]&3|8,1);var e=b.join("");return e}function i(b){if(a.typeMapper&&a.typeMapper.defaultValue)return a.typeMapper.defaultValue(b);switch(b){case"TEXT":return"";case"BOOL":return!1;default:return b.indexOf("INT")!==-1?0:b.indexOf("CHAR")!==-1?"":null}}function j(a,b){var c=a.length;for(var d=0;d<c;d++){var e=a[d];if(e.equals&&e.equals(b))return!0;if(e===b)return!0}return!1}function k(a,b){var c=a.length;for(var d=0;d<c;d++){var e=a[d];if(e.equals&&e.equals(b)){a.splice(d,1);return}if(e===b){a.splice(d,1);return}}}function l(a,b,c){this.obj=a,this.eventType=b,this.fn=c}function m(){this.subscribers={}}function n(){}function o(a,b){this.left=a,this.right=b}function p(a,b){this.left=a,this.right=b}function q(a,b,c){this.property=a,this.operator=b.toLowerCase(),this.value=c}function r(){}function s(a,b){this.init(a,b,s)}function t(a,b){this.init(a,b,t)}function u(b,c){this.init(b,c,a.ManyToManyDbQueryCollection),this._localAdded=[],this._localRemoved=[]}function v(b){this.init(a,null,v),this._items=b||[]}var c={},d={};a.getEntityMeta=function(){return c},a.trackedObjects={},a.objectsToRemove={},a.objectsRemoved=[],a.globalPropertyListeners={},a.queryCollectionCache={},a.getObjectsToRemove=function(){return this.objectsToRemove},a.getTrackedObjects=function(){return this.trackedObjects},a.entityDecoratorHooks=[],a.flushHooks=[],a.schemaSyncHooks=[],a.debug=!0,a.subscribeToGlobalPropertyListener=function(a,b,c){var d=b+"__"+c;if(d in this.globalPropertyListeners){var e=this.globalPropertyListeners[d];for(var f=0;f<e.length;f++)if(e[f]===a)return;this.globalPropertyListeners[d].push(a)}else this.globalPropertyListeners[d]=[a]},a.unsubscribeFromGlobalPropertyListener=function(a,b,c){var d=b+"__"+c,e=this.globalPropertyListeners[d];for(var f=0;f<e.length;f++)if(e[f]===a){e.splice(f,1);return}},a.propertyChanged=function(a,b,c,d){if(!this.trackedObjects[a.id])return;var e=a._type,f=e+"__"+b;if(f in this.globalPropertyListeners){var g=this.globalPropertyListeners[f];for(var h=0;h<g.length;h++){var i=g[h],j=a._data;j[b]=c;var k=i._filter.match(j);j[b]=d;var l=i._filter.match(j);k!=l&&i.triggerEvent("change",i,a)}}},a.objectRemoved=function(a){var b=a._type;if(this.queryCollectionCache[b]){var c=this.queryCollectionCache[b];for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];e._filter.match(a)&&e.triggerEvent("change",e,a)}}},a.getMeta=e,f.prototype=a,a.Session=f,a.define=function(a,b){if(c[a])return g(a);var d={name:a,fields:b,isMixin:!1,indexes:[],hasMany:{},hasOne:{}};return c[a]=d,g(a)},a.isDefined=function(a){return!!c[a]},a.defineMixin=function(a,b){var c=this.define(a,b);return c.meta.isMixin=!0,c},a.isTransaction=function(a){return!a||a&&a.executeSql},a.isSession=function(a){return!a||a&&a.schemaSync},a.add=function(a){if(!a)return;if(!this.trackedObjects[a.id]){this.trackedObjects[a.id]=a;if(a._new)for(var b in a._data)a._data.hasOwnProperty(b)&&this.propertyChanged(a,b,undefined,a._data[b])}return this},a.remove=function(a){return this.objectsToRemove[a.id]||(this.objectsToRemove[a.id]=a),this.objectsRemoved.push({id:a.id,entity:a._type}),this.objectRemoved(a),this},a.clean=function(){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={}},a.asyncForEach=function(a,b,c){function d(){var e=a.pop();b(e,function(b,e){a.length>0?d():c(b,e)})}a=a.slice(0),a.length>0?d():c()},a.asyncParForEach=function(a,b,c){var d=0,e=a.length;e===0&&c();for(var f=0;f<e;f++)b(a[f],function(a,b){d++,d===e&&c(a,b)})},a.jsonToEntityVal=function(a,b){if(!b)return a;switch(b){case"DATE":return typeof a=="number"?a>1e12?new Date(a):new Date(a*1e3):null;default:return a}},a.entityValToJson=function(a,b){if(!b)return a;switch(b){case"DATE":return a?(a=new Date(a),Math.round(a.getTime()/1e3)):null;default:return a}},a.dump=function(c,e,f){var g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return!a||a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);c=g.tx,e=g.entities,f=g.callback;if(!e){e=[];for(var h in d)d.hasOwnProperty(h)&&e.push(d[h])}var i={};a.asyncParForEach(e,function(b,d){b.all().list(c,function(e){var f=[];a.asyncParForEach(e,function(d,e){var g={},h=b.meta.fields;for(var i in h)h.hasOwnProperty(i)&&(g[i]=a.entityValToJson(d._data[i],h[i]));var j=b.meta.hasOne;for(var k in j)j.hasOwnProperty(k)&&(g[k]=d._data[k]);var l=b.meta.hasMany,m=[];for(var n in l)l.hasOwnProperty(n)&&m.push(n);a.asyncParForEach(m,function(b,e){var f=a.get(d,b);f.list(c,function(a){g[b]=a.map(function(a){return a.id}),e()})},function(){g.id=d.id,f.push(g),e()})},function(){i[b.meta.name]=f,d()})})},function(){f(i)})},a.load=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"dump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.dump,e=f.callback;var h=0,i=[],j=this;for(var k in d)if(d.hasOwnProperty(k)){var l=g(k),m=l.meta.fields,n=d[k];for(var o=0;o<n.length;o++){var p=n[o],q=new l;q.id=p.id;for(var r in p)if(p.hasOwnProperty(r))if(a.isImmutable(r))q[r]=p[r];else if(l.meta.hasMany[r]){var s=l.meta.hasMany[r];if(s.manyToMany&&l.meta.name<s.type.meta.name)continue;var t=a.get(q,r);p[r].length>0&&p[r].forEach(function(a){i.push({Entity:l,coll:t,id:a})})}else a.set(q,r,a.jsonToEntityVal(p[r],m[r]));this.add(q)}}j.flush(c,function(){a.asyncForEach(i,function(a,b){a.Entity.load(j,c,a.id,function(c){a.coll.add(c),b()})},function(){j.flush(c,e)})})},a.dumpToJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.entities,e=f.callback,this.dump(c,d,function(a){e(JSON.stringify(a))})},a.loadFromJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonDump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.jsonDump,e=f.callback,this.load(c,JSON.parse(d),e)},a.createUUID=h,l.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn)},m.prototype.addEventListener=function(a,b){return this.subscribers[a]||(this.subscribers[a]=[]),this.subscribers[a].push(b),new l(this,a,b)},m.prototype.removeEventListener=function(a,b){var c=this.subscribers[a];for(var d=0;d<c.length;d++)if(c[d]==b)return this.subscribers[a].splice(d,1),!0;return!1},m.prototype.triggerEvent=function(a){if(!this.subscribers[a])return;var b=this.subscribers[a].slice(0);for(var c=0;c<b.length;c++)b[c].apply(null,arguments)},n.prototype.match=function(a){return!0},n.prototype.makeFit=function(a){},n.prototype.makeNotFit=function(a){},n.prototype.toUniqueString=function(){return"NULL"},n.prototype.subscribeGlobally=function(){},n.prototype.unsubscribeGlobally=function(){},o.prototype.match=function(a){return this.left.match(a)&&this.right.match(a)},o.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},o.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},o.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()},o.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},o.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},p.prototype.match=function(a){return this.left.match(a)||this.right.match(a)},p.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},p.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},p.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString()},p.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},p.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},q.prototype.match=function(b){var c=this.value,d=a.get(b,this.property);c&&c.getTime&&(c=Math.round(c.getTime()/1e3)*1e3,d&&d.getTime&&(d=Math.round(d.getTime()/1e3)*1e3));switch(this.operator){case"=":return d===c;case"!=":return d!==c;case"<":return d<c;case"<=":return d<=c;case">":return d>c;case">=":return d>=c;case"in":return j(c,d);case"not in":return!j(c,d)}},q.prototype.makeFit=function(b){if(this.operator!=="=")throw new Error("Sorry, can't perform makeFit for other filters than =");a.set(b,this.property,this.value)},q.prototype.makeNotFit=function(b){if(this.operator!=="=")throw new Error("Sorry, can't perform makeNotFit for other filters than =");a.set(b,this.property,null)},q.prototype.subscribeGlobally=function(b,c){a.subscribeToGlobalPropertyListener(b,c,this.property)},q.prototype.unsubscribeGlobally=function(b,c){a.unsubscribeFromGlobalPropertyListener(b,c,this.property)},q.prototype.toUniqueString=function(){var a=this.value;return a&&a._type&&(a=a.id),this.property+this.operator+a},a.NullFilter=n,a.AndFilter=o,a.OrFilter=p,a.PropertyFilter=q,a.uniqueQueryCollection=function(a){var b=a._entityName;if(a._items)return a;this.queryCollectionCache[b]||(this.queryCollectionCache[b]={});var c=a.toUniqueString();return this.queryCollectionCache[b][c]||(this.queryCollectionCache[b][c]=a),this.queryCollectionCache[b][c]},r.prototype=new m,r.prototype.oldAddEventListener=r.prototype.addEventListener,r.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName)},r.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName)},r.prototype.addEventListener=function(a,b){var c=this,d=this.oldAddEventListener(a,b);return this.subscribers[a].length===1&&this.setupSubscriptions(),d.oldUnsubscribe=d.unsubscribe,d.unsubscribe=function(){this.oldUnsubscribe(),c.subscribers[a].length===0&&c.teardownSubscriptions()},d},r.prototype.persistQueries=function(){return[]},r.prototype.init=function(b,c,d){this._filter=new n,this._orderColumns=[],this._prefetchFields=[],this._entityName=c,this._constructor=d,this._limit=-1,this._skip=0,this._reverse=!1,this._session=b||a,this.subscribers={}},r.prototype.toUniqueString=function(){var a=this._constructor.name+": "+this._entityName;a+="|Filter:";var b=[];a+=this._filter.toUniqueString(),a+="|Values:";for(var c=0;c<b.length;c++)a+=b+"|^|";a+="|Order:";for(var c=0;c<this._orderColumns.length;c++){var d=this._orderColumns[c];a+=d[0]+", "+d[1]+", "+d[2]}a+="|Prefetch:";for(var c=0;c<this._prefetchFields.length;c++)a+=this._prefetchFields[c];return a+="|Limit:",a+=this._limit,a+="|Skip:",a+=this._skip,a+="|Reverse:",a+=this._reverse,a},r.prototype.clone=function(a){var b=new this._constructor(this._session,this._entityName);b._filter=this._filter,b._prefetchFields=this._prefetchFields.slice(0),b._orderColumns=this._orderColumns.slice(0),b._limit=this._limit,b._skip=this._skip,b._reverse=this._reverse;if(a){var c={};for(var d in this.subscribers)this.subscribers.hasOwnProperty(d)&&(c[d]=this.subscribers[d].slice(0));b.subscribers=c}else b.subscribers=this.subscribers;return b},r.prototype.filter=function(a,b,c){var d=this.clone(!0);d._filter=new o(this._filter,new q(a,b,c));var e=this._session;return d=e.uniqueQueryCollection(d),e.uniqueQueryCollection(d)},r.prototype.or=function(a){var b=this.clone(!0);return b._filter=new p(this._filter,a),this._session.uniqueQueryCollection(b)},r.prototype.and=function(a){var b=this.clone(!0);return b._filter=new o(this._filter,a),this._session.uniqueQueryCollection(b)},r.prototype.order=function(a,b,c){b=b===undefined?!0:b,c=c===undefined?!0:c;var d=this.clone();return d._orderColumns.push([a,b,c]),this._session.uniqueQueryCollection(d)},r.prototype.limit=function(a){var b=this.clone();return b._limit=a,this._session.uniqueQueryCollection(b)},r.prototype.skip=function(a){var b=this.clone();return b._skip=a,this._session.uniqueQueryCollection(b)},r.prototype.reverse=function(){var a=this.clone();return a._reverse=!0,this._session.uniqueQueryCollection(a)},r.prototype.prefetch=function(a){var b=this.clone();return b._prefetchFields.push(a),this._session.uniqueQueryCollection(b)},r.prototype.selectJSON=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]),h=this._session,i=this;c=f.tx,d=f.props,e=f.callback;if(!c){h.transaction(function(a){i.selectJSON(a,d,e)});return}var j=g(this._entityName);this.list(function(b){var f=[];a.asyncForEach(b,function(a,b){a.selectJSON(c,d,function(a){f.push(a),b()})},function(){e(f)})})},r.prototype.add=function(a){if(!a.id||!a._type)throw new Error("Cannot add object of non-entity type onto collection.");this._session.add(a),this._filter.makeFit(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},r.prototype.addAll=function(a){for(var b=0;b<a.length;b++){var c=a[b];this._session.add(c),this._filter.makeFit(c),this.triggerEvent("add",this,c)}this.triggerEvent("change",this)},r.prototype.remove=function(a){if(!a.id||!a._type)throw new Error("Cannot remove object of non-entity type from collection.");this._filter.makeNotFit(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},r.prototype.each=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"eachFn",optional:!0,check:b.isCallback()}]);c=e.tx,d=e.eachFn,this.list(c,function(a){for(var b=0;b<a.length;b++)d(a[b])})},r.prototype.forEach=r.prototype.each,r.prototype.one=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"oneFn",optional:!1,check:b.isCallback()}]);c=e.tx,d=e.oneFn;var f=this;this.limit(1).list(c,function(a){a.length===0?d(null):d(a[0])})},s.prototype=new r,t.prototype=new s,t.prototype.add=function(a){this._session.add(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},t.prototype.remove=function(a){this._session.remove(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},u.prototype=new s,u.prototype.initManyToMany=function(a,b){this._obj=a,this._coll=b},u.prototype.add=function(a){j(this._localAdded,a)||(this._session.add(a),this._localAdded.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},u.prototype.addAll=function(a){for(var b=0;b<a.length;b++){var c=a[b];j(this._localAdded,c)||(this._session.add(c),this._localAdded.push(c),this.triggerEvent("add",this,c))}this.triggerEvent("change",this)},u.prototype.clone=function(){var a=s.prototype.clone.call(this);return a._localAdded=this._localAdded,a._localRemoved=this._localRemoved,a._obj=this._obj,a._coll=this._coll,a},u.prototype.remove=function(a){j(this._localAdded,a)?k(this._localAdded,a):j(this._localRemoved,a)||this._localRemoved.push(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},v.prototype=new r,v.prototype.clone=function(){var a=s.prototype.clone.call(this);return a._items=this._items,a},v.prototype.add=function(a){j(this._items,a)||(this._session.add(a),this._items.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},v.prototype.addAll=function(a){for(var b=0;b<a.length;b++){var c=a[b];j(this._items,c)||(this._session.add(c),this._items.push(c),this.triggerEvent("add",this,c))}this.triggerEvent("change",this)},v.prototype.remove=function(a){var b=this._items;for(var c=0;c<b.length;c++)b[c]===a&&(this._items.splice(c,1),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a))},v.prototype.list=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);d=e.callback;if(!d||d.executeSql)d=arguments[1];var f=this._items.slice(0),g=this,h=[];for(var i=0;i<f.length;i++)this._filter.match(f[i])&&h.push(f[i]);h.sort(function(b,c){for(var d=0;d<g._orderColumns.length;d++){var e=g._orderColumns[d][0],f=g._orderColumns[d][1],h=g._orderColumns[d][2],i=a.get(b,e),j=a.get(c,e);h||(i=i.toLowerCase(),j=j.toLowerCase());if(i<j)return f?-1:1;if(i>j)return f?1:-1}return 0}),this._skip&&h.splice(0,this._skip),this._limit>-1&&(h=h.slice(0,this._limit)),this._reverse&&h.reverse();if(!d)return h;d(h)},v.prototype.destroyAll=function(a){if(!a||a.executeSql)a=arguments[1];this._items=[],this.triggerEvent("change",this),a&&a()},v.prototype.count=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);c=e.tx,d=e.callback;var f=this.list();if(!d)return f.length;d(f.length)},a.QueryCollection=r,a.DbQueryCollection=s,a.ManyToManyDbQueryCollection=u,a.LocalQueryCollection=v,a.Observable=m,a.Subscription=l,a.AndFilter=o,a.OrFilter=p,a.PropertyFilter=q}();var b={};return function(){b.getArgs=function(a,b){var c=0,d=0,e={};while(d<b.length){var f=b[d],g=a[c];if(f.optional)g!==undefined&&f.check(g)?(e[f.name]=g,c++,d++):(f.defaultValue!==undefined&&(e[f.name]=f.defaultValue),d++);else{if(f.check&&!f.check(g))throw new Error("Invalid value for argument: "+f.name+" Value: "+g);e[f.name]=g,d++,c++}}return e},b.hasProperty=function(a){return function(b){return b&&b[a]!==undefined}},b.hasType=function(a){return function(b){return typeof b===a}},b.isCallback=function(){return function(a){return a&&a.apply}}}(),a.argspec=b,a}if(typeof exports!="undefined"){exports.createPersistence=function(){return initPersistence({})};var singleton;exports.__defineGetter__("persistence",function(){return singleton||(singleton=exports.createPersistence()),singleton})}else window=window||{},window.persistence=initPersistence(window.persistence||{});typeof JSON=="undefined"&&(JSON={}),JSON.stringify||function(){function f(a){return a<10?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return typeof b=="string"?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g=gap,h,i=b[a];i&&typeof i=="object"&&typeof i.toJSON=="function"&&(i=i.toJSON(a)),typeof rep=="function"&&(i=rep.call(b,a,i));switch(typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";gap+=indent,h=[];if(Object.prototype.toString.apply(i)==="[object Array]"){f=i.length;for(c=0;c<f;c+=1)h[c]=str(c,i)||"null";return e=h.length===0?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g,e}if(rep&&typeof rep=="object"){f=rep.length;for(c=0;c<f;c+=1)d=rep[c],typeof d=="string"&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e))}else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));return e=h.length===0?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g,e}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(a,b,c){var d;gap="",indent="";if(typeof c=="number")for(d=0;d<c;d+=1)indent+=" ";else typeof c=="string"&&(indent=c);rep=b;if(!b||typeof b=="function"||typeof b=="object"&&typeof b.length=="number")return str("",{"":a});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&typeof e=="object")for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),d!==undefined?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}()
