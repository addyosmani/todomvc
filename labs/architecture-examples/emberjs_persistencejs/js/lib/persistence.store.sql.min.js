function config(a,b){function d(b,c,d,e){e=e||"";if(b.trackedObjects[d[e+"id"]])return b.trackedObjects[d[e+"id"]];var f=a.typeMapper,g=a.getMeta(c),h=a.define(c);if(!d[e+"id"])return null;var i=new h(b,undefined,!0);i.id=f.dbValToEntityVal(d[e+"id"],f.idType),i._new=!1;for(var j in d)if(d.hasOwnProperty(j)&&j.substring(0,e.length)===e){var k=j.substring(e.length);k!="id"&&(i._data[k]=f.dbValToEntityVal(d[j],g.fields[k]||f.idType))}return i}function e(b,c,d){var e=a.getMeta(b._type),f=a.typeMapper,h=[],i=[],j=[],k=[];if(b._new)for(var l in e.fields)e.fields.hasOwnProperty(l)&&(b._dirtyProperties[l]=!0);for(var l in b._dirtyProperties)if(b._dirtyProperties.hasOwnProperty(l)){h.push("`"+l+"`");var m=e.fields[l]||f.idType;i.push(f.entityValToDbVal(b._data[l],m)),j.push(f.outVar("?",m)),k.push("`"+l+"` = "+f.outVar("?",m))}var n=[];for(var l in e.hasMany)e.hasMany.hasOwnProperty(l)&&(n=n.concat(a.get(b,l).persistQueries()));g(c,n,function(){if(!b._new&&h.length===0){d&&d();return}b._dirtyProperties={};if(b._new){h.push("id"),i.push(f.entityIdToDbId(b.id)),j.push(f.outIdVar("?"));var a="INSERT INTO `"+b._type+"` ("+h.join(", ")+") VALUES ("+j.join(", ")+")";b._new=!1,c.executeSql(a,i,d,d)}else{var a="UPDATE `"+b._type+"` SET "+k.join(",")+" WHERE id = "+f.outId(b.id);c.executeSql(a,i,d,d)}})}function f(b,c,d){var e=a.getMeta(b._type),f=a.typeMapper,h=[["DELETE FROM `"+b._type+"` WHERE id = "+f.outId(b.id),null]];for(var i in e.hasMany)if(e.hasMany.hasOwnProperty(i)&&e.hasMany[i].manyToMany){var j=e.hasMany[i].tableName;h.push(["DELETE FROM `"+j+"` WHERE `"+e.name+"_"+i+"` = "+f.outId(b.id),null])}g(c,h,d)}function g(b,c,d){var e=[];for(var f=3;f<arguments.length;f++)e.push(arguments[f]);a.asyncForEach(c,function(a,c){b.executeSql(a[0],a[1],c,function(a,b){console.log(b.message),c(a,b)})},function(a,b){if(b&&d){d(a,b);return}d&&d.apply(null,e)})}var c=a.argspec;a.typeMapper=b.typeMapper||defaultTypeMapper,a.generatedTables={},a.schemaSync=function(d,e,f){var h=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:c.hasType("boolean")}]);d=h.tx,e=h.callback,f=h.emulate;if(!d){var i=this;this.transaction(function(a){i.schemaSync(a,e,f)});return}var j=[],k,l,m,n,o=a.typeMapper,p=a.getEntityMeta();for(var q in p)if(p.hasOwnProperty(q)){k=p[q];if(!k.isMixin){l=[];for(var r in k.fields)k.fields.hasOwnProperty(r)&&l.push([r,k.fields[r]]);for(var s in k.hasOne)k.hasOne.hasOwnProperty(s)&&(m=k.hasOne[s].type.meta,l.push([s,o.idType]),j.push([b.createIndex(k.name,[s]),null]));for(var t=0;t<k.indexes.length;t++)j.push([b.createIndex(k.name,k.indexes[t].columns,k.indexes[t]),null])}for(var s in k.hasMany)if(k.hasMany.hasOwnProperty(s)&&k.hasMany[s].manyToMany){n=k.hasMany[s].tableName;if(!a.generatedTables[n]){var m=k.hasMany[s].type.meta,u=k.hasMany[s].inverseProperty;if(m.hasMany[u].type.meta!=k)continue;var v=k.name+"_"+s,w=m.name+"_"+u;j.push([b.createIndex(n,[v]),null]),j.push([b.createIndex(n,[w]),null]);var x=[[v,o.idType],[w,o.idType]];k.isMixin&&x.push([v+"_class",o.classNameType]),m.isMixin&&x.push([w+"_class",o.classNameType]),j.push([b.createTable(n,x),null]),a.generatedTables[n]=!0}}k.isMixin||(l.push(["id",o.idType,"PRIMARY KEY"]),a.generatedTables[k.name]=!0,j.push([b.createTable(k.name,l),null]))}var y=a.schemaSyncHooks;for(var t=0;t<y.length;t++)y[t](d);f?e(d):g(d,j,function(a,b){e(d,b)})},a.flush=function(b,d){var g=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:null}]);b=g.tx,d=g.callback;var h=this;if(!b){this.transaction(function(a){h.flush(a,d)});return}var i=a.flushHooks;a.asyncForEach(i,function(a,c){a(h,b,c)},function(){var c=[];for(var g in h.trackedObjects)h.trackedObjects.hasOwnProperty(g)&&c.push(h.trackedObjects[g]);var i=[];for(var g in h.objectsToRemove)h.objectsToRemove.hasOwnProperty(g)&&(i.push(h.objectsToRemove[g]),delete h.trackedObjects[g]);h.objectsToRemove={};if(d)a.asyncParForEach(i,function(a,c){f(a,b,c)},function(f,g){if(g)return d(f,g);a.asyncParForEach(c,function(a,c){e(a,b,c)},d)});else{for(var j=0;j<c.length;j++)e(c[j],b);for(var j=0;j<i.length;j++)f(i[j],b)}})},a.reset=function(b,d){var e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);b=e.tx,d=e.callback;var f=this;if(!b){f.transaction(function(a){f.reset(a,d)});return}this.schemaSync(b,function(){function g(){var a=c.pop();b.executeSql("DROP TABLE IF EXISTS `"+a+"`",null,function(){c.length>0?g():h()},h)}function h(b,c){f.clean(),a.generatedTables={},d&&d(b,c)}var c=[];for(var e in a.generatedTables)a.generatedTables.hasOwnProperty(e)&&c.push(e);c.length>0?g():h()},!0)},a.save=e,a.executeQueriesSeq=g,a.QueryCollection.prototype.persistQueries=function(){return[]};var h=a.QueryCollection.prototype.clone;a.QueryCollection.prototype.clone=function(a){var b=h.call(this,a);return b._additionalJoinSqls=this._additionalJoinSqls.slice(0),b._additionalWhereSqls=this._additionalWhereSqls.slice(0),b._additionalGroupSqls=this._additionalGroupSqls.slice(0),b._manyToManyFetch=this._manyToManyFetch,b};var i=a.QueryCollection.prototype.init;a.QueryCollection.prototype.init=function(a,b,c){i.call(this,a,b,c),this._manyToManyFetch=null,this._additionalJoinSqls=[],this._additionalWhereSqls=[],this._additionalGroupSqls=[]};var j=a.QueryCollection.prototype.toUniqueString;a.QueryCollection.prototype.toUniqueString=function(){var a=j.call(this);a+="|JoinSQLs:";for(var b=0;b<this._additionalJoinSqls.length;b++)a+=this._additionalJoinSqls[b];a+="|WhereSQLs:";for(var b=0;b<this._additionalWhereSqls.length;b++)a+=this._additionalWhereSqls[b];a+="|GroupSQLs:";for(var b=0;b<this._additionalGroupSqls.length;b++)a+=this._additionalGroupSqls[b];return this._manyToManyFetch&&(a+="|ManyToManyFetch:",a+=JSON.stringify(this._manyToManyFetch)),a},a.NullFilter.prototype.sql=function(a,b,c){return"1=1"},a.AndFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" AND "+this.right.sql(a,b,c)+")"},a.OrFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" OR "+this.right.sql(a,b,c)+")"},a.PropertyFilter.prototype.sql=function(b,c,d){var e=a.typeMapper,f=c?"`"+c+"`.":"",g=b.fields[this.property]||e.idType;if(this.operator==="="&&this.value===null)return f+"`"+this.property+"` IS NULL";if(this.operator==="!="&&this.value===null)return f+"`"+this.property+"` IS NOT NULL";if(this.operator==="in"){var h=this.value,i=[];for(var j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return h.length===0?"1 = 0":f+"`"+this.property+"` IN ("+i.join(", ")+")"}if(this.operator==="not in"){var h=this.value,i=[];for(var j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return h.length===0?"1 = 1":f+"`"+this.property+"` NOT IN ("+i.join(", ")+")"}var k=this.value;if(k===!0||k===!1)k=k?1:0;return d.push(e.entityValToDbVal(k,g)),f+"`"+this.property+"` "+this.operator+" "+e.outVar("?",g)},a.DbQueryCollection.prototype.list=function(b,e){function m(a,b,c){var d=[k.inIdVar("`"+b+"`.id")+" AS "+c+"id"];for(var e in a.fields)a.fields.hasOwnProperty(e)&&d.push(k.inVar("`"+b+"`.`"+e+"`",a.fields[e])+" AS `"+c+e+"`");for(var e in a.hasOne)a.hasOne.hasOwnProperty(e)&&d.push(k.inIdVar("`"+b+"`.`"+e+"`")+" AS `"+c+e+"`");return d}var f=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);b=f.tx,e=f.callback;var g=this,h=this._session;if(!b){h.transaction(function(a){g.list(a,e)});return}var i=this._entityName,j=a.getMeta(i),k=a.typeMapper;if(j.isMixin){var l=[];a.asyncForEach(j.mixedIns,function(a,c){var d=g.clone();d._entityName=a.name,d.list(b,function(a){l=l.concat(a),c()})},function(){var b=new a.LocalQueryCollection(l);b._orderColumns=g._orderColumns,b._reverse=g._reverse,b.list(null,e)});return}var f=[],n=i+"_",o="root",p=m(j,o,n),q="",r=this._additionalWhereSqls.slice(0),s=this._manyToManyFetch;s&&(q+="LEFT JOIN `"+s.table+"` AS mtm ON mtm.`"+s.inverseProp+"` = `root`.`id` ",r.push("mtm.`"+s.prop+"` = "+k.outId(s.id))),q+=this._additionalJoinSqls.join(" ");for(var t=0;t<this._prefetchFields.length;t++){var u=this._prefetchFields[t],v=j.hasOne[u].type.meta;if(v.isMixin)throw new Error("cannot prefetch a mixin");var w=v.name+"_"+u+"_tbl";p=p.concat(m(v,w,u+"_")),q+="LEFT JOIN `"+v.name+"` AS `"+w+"` ON `"+w+"`.`id` = `"+o+"`.`"+u+"` "}var x="WHERE "+[this._filter.sql(j,o,f)].concat(r).join(" AND "),y="SELECT "+p.join(", ")+" FROM `"+i+"` AS `"+o+"` "+q+" "+x;this._additionalGroupSqls.length>0&&(y+=this._additionalGroupSqls.join(" ")),this._orderColumns.length>0&&(y+=" ORDER BY "+this._orderColumns.map(function(a){return(a[2]?"`":"LOWER(`")+n+a[0]+(a[2]?"` ":"`) ")+(a[1]?"ASC":"DESC")}).join(", ")),this._limit>=0&&(y+=" LIMIT "+this._limit),this._skip>0&&(y+=" OFFSET "+this._skip),h.flush(b,function(){b.executeSql(y,f,function(a){var b=[];g._reverse&&a.reverse();for(var c=0;c<a.length;c++){var f=a[c],k=d(h,i,f,n);for(var l=0;l<g._prefetchFields.length;l++){var m=g._prefetchFields[l],o=j.hasOne[m].type.meta;k._data_obj[m]=d(h,o.name,f,m+"_"),h.add(k._data_obj[m])}b.push(k),h.add(k)}e(b),g.triggerEvent("list",g,b)})})},a.DbQueryCollection.prototype.destroyAll=function(b,d){var e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);b=e.tx,d=e.callback;var f=this,g=this._session;if(!b){g.transaction(function(a){f.destroyAll(a,d)});return}var h=this._entityName,i=a.getMeta(h),j=a.typeMapper;if(i.isMixin){a.asyncForEach(i.mixedIns,function(a,c){var e=f.clone();e._entityName=a.name,e.destroyAll(b,d)},d);return}var k="",l=this._additionalWhereSqls.slice(0),m=this._manyToManyFetch;m&&(k+="LEFT JOIN `"+m.table+"` AS mtm ON mtm.`"+m.inverseProp+"` = `root`.`id` ",l.push("mtm.`"+m.prop+"` = "+j.outId(m.id))),k+=this._additionalJoinSqls.join(" ");var e=[],n="WHERE "+[this._filter.sql(i,null,e)].concat(l).join(" AND "),o="SELECT id FROM `"+h+"` "+k+" "+n,p="DELETE FROM `"+h+"` "+k+" "+n,q=e.slice(0);g.flush(b,function(){b.executeSql(o,e,function(a){for(var c=0;c<a.length;c++)delete g.trackedObjects[a[c].id],g.objectsRemoved.push({id:a[c].id,entity:h});f.triggerEvent("change",f),b.executeSql(p,q,d,d)},d)})},a.DbQueryCollection.prototype.count=function(b,d){var e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);b=e.tx,d=e.callback;var f=this,g=this._session;b&&!b.executeSql&&(d=b,b=null);if(!b){g.transaction(function(a){f.count(a,d)});return}var h=this._entityName,i=a.getMeta(h),j=a.typeMapper;if(i.isMixin){var k=0;a.asyncForEach(i.mixedIns,function(a,c){var d=f.clone();d._entityName=a.name,d.count(b,function(a){k+=a,c()})},function(){d(k)});return}var l="",m=this._additionalWhereSqls.slice(0),n=this._manyToManyFetch;n&&(l+="LEFT JOIN `"+n.table+"` AS mtm ON mtm.`"+n.inverseProp+"` = `root`.`id` ",m.push("mtm.`"+n.prop+"` = "+j.outId(n.id))),l+=this._additionalJoinSqls.join(" ");var e=[],o="WHERE "+[this._filter.sql(i,"root",e)].concat(m).join(" AND "),p="SELECT COUNT(*) AS cnt FROM `"+h+"` AS `root` "+l+" "+o;g.flush(b,function(){b.executeSql(p,e,function(a){d(parseInt(a[0].cnt,10))})})},a.ManyToManyDbQueryCollection.prototype.persistQueries=function(){var b=[],c=a.getMeta(this._obj._type),d=c.hasMany[this._coll].type.meta,e=a.typeMapper,f=c.hasMany[this._coll],g=d.hasMany[f.inverseProperty],h=f.mixin?f.mixin.meta.name:c.name,i=g.mixin?g.mixin.meta.name:d.name;for(var j=0;j<this._localAdded.length;j++){var k=[h+"_"+this._coll,i+"_"+f.inverseProperty],l=[e.outIdVar("?"),e.outIdVar("?")],m=[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localAdded[j].id)];f.mixin&&(k.push(h+"_"+this._coll+"_class"),l.push("?"),m.push(c.name)),g.mixin&&(k.push(i+"_"+f.inverseProperty+"_class"),l.push("?"),m.push(d.name)),b.push(["INSERT INTO "+f.tableName+" (`"+k.join("`, `")+"`) VALUES ("+l.join(",")+")",m])}this._localAdded=[];for(var j=0;j<this._localRemoved.length;j++)b.push(["DELETE FROM  "+f.tableName+" WHERE `"+h+"_"+this._coll+"` = "+e.outIdVar("?")+" AND `"+i+"_"+f.inverseProperty+"` = "+e.outIdVar("?"),[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localRemoved[j].id)]]);return this._localRemoved=[],b}}var defaultTypeMapper={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(a){switch(a){case"JSON":return"TEXT";case"BOOL":return"INT";case"DATE":return"INT";default:return a}},inVar:function(a,b){return a},outVar:function(a,b){return a},outId:function(a){return"'"+a+"'"},dbValToEntityVal:function(a,b){if(a===null||a===undefined)return a;switch(b){case"DATE":return a>1e12?new Date(parseInt(a,10)):new Date(parseInt(a,10)*1e3);case"BOOL":return a===1||a==="1";case"INT":return+a;case"BIGINT":return+a;case"JSON":return a?JSON.parse(a):a;default:return a}},entityValToDbVal:function(a,b){return a===undefined||a===null?null:b==="JSON"&&a?JSON.stringify(a):a.id?a.id:b==="BOOL"?a==="false"?0:a?1:0:b==="DATE"||a.getTime?(a=new Date(a),Math.round(a.getTime()/1e3)):a},inIdVar:function(a){return this.inVar(a,this.idType)},outIdVar:function(a){return this.outVar(a,this.idType)},entityIdToDbId:function(a){return this.entityValToDbVal(a,this.idType)}};typeof exports!="undefined"?(exports.defaultTypeMapper=defaultTypeMapper,exports.config=config):(window=window||{},window.persistence=window.persistence||{},window.persistence.store=window.persistence.store||{},window.persistence.store.sql={defaultTypeMapper:defaultTypeMapper,config:config})
